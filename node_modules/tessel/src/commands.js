require("zlib"),require("path"),require("fs");var e=require("stream"),t=require("structured-clone"),i=require("../src/logs"),n=require("humanize"),s=require("./").Tessel.prototype,o={disconnect:function(e,t){e.postMessage(89,new Buffer(4),t)},connect:function(e,t,i,n,s){var o=new Buffer(128);o.fill(0),t.copy(o,0,0,t.length),i.copy(o,32,0,i.length),n.copy(o,96,0,n.length),e.postMessage(87,o,s)},macAddress:function(e,t){e.postMessage(99,null,t)},writeStdin:function(e,t,i){e.postMessage(110,t,i)},ping:function(e,t){e.postMessage(71,new Buffer("ping"),t)},checkWifi:function(e,t,i){e.postMessage(67,new Buffer([t?1:0]),i)},uploadRam:function(e,t,i){e.postMessage(85,t,i)},uploadFlash:function(e,t,i){e.postMessage(80,t,i)},writeProcessMessage:function(e,i,n){e.postMessage(77,t.serialize(i),n)},requestWifiNetworksAndStatus:function(e,t){e.postMessage(86,null,t)},enterBootloader:function(e,t){e.postMessage(66,null,t)},eraseWifiProfiles:function(e,t){e.postMessage(68,new Buffer("erase"),t)}};Object.defineProperty(s,"interface",{get:function(){var e,t={};for(e in o)t[e]=o[e].bind(this,this);return t}}),s.initCommands=function(){var i=this;this.on("rawMessage:0053",function(e){var t=parseInt(e+"");t>0?this.emit("script-start"):this.emit("script-stop",-t)}),this.on("rawMessage:0055",function(e){var t=JSON.parse(e);this.emit("upload-status",t)}),this.on("rawMessage:0057",function(e){var t=JSON.parse(e);this.emit("wifi-"+t.event,t)}),this.on("rawMessage:0056",function(e){var t=JSON.parse(e);this.emit("wifi-list",t)}),this.on("rawMessage:004d",function(e){this.emit("message",t.deserialize(e))}),this.on("rawMessage:006b",function(e){this.emit("debug-stack",e.toString("utf-8"))}),this.on("rawMessage:0063",function(e){var t=JSON.parse(e);this.emit("mac-address",t)}),this.on("rawMessage:0047",function(e){var t=JSON.parse(e);this.emit("pong",t)}),this.on("rawMessage:0044",function(e){this.emit("wifi-profile-erase",parseInt(e.toString("utf-8")))}),this.stdout=new e.Readable,this.stdout._read=function(){},this.stdout.pause(),this.stderr=new e.Readable,this.stderr._read=function(){},this.stderr.pause(),this.stdin=new e.Writable,this.stdin._write=function(e,t,n){o.writeStdin(i,Buffer.isBuffer(e)?e:new Buffer(e,t),n)},this.on("log",function(e,t){30==e&&i.stdout.push(t),31==e&&i.stderr.push(t),10!=e&&11!=e&&12!=e||i.stdout.push(t+"\n"),13!=e&&22!=e||i.stderr.push(t+"\n")})},s.enterBootloader=function(e){var t=this;t.claim(!0,function(){t.log_ep.stopPoll(function(){t.msg_in_ep.stopPoll(function(){o.enterBootloader(t,function(i){if(i)return e&&e(i);t.usb.close(),t.closed=!0,t.reFind("boot",e)})})})})},s.ping=function(e,t){function i(e){s&&(clearTimeout(s),n.removeListener("pong",i),t(null,e))}var n,s;"function"==typeof e&&(t=e,e=null),(e=e||{}).timeout=e.timeout||3e3,n=this,s=setTimeout(function(){s&&(clearTimeout(s),s=null,t(Error("timeout occurred after "+e.timeout/1e3+" seconds!"),null))},e.timeout),n.once("pong",i),o.ping(n)},s.wifiStatus=function(e){o.requestWifiNetworksAndStatus(this,function(){i.info("Requesting wifi status...".grey)}),this.once("wifi-list",function(t){e(null,t)})},s.wifiErase=function(e){o.eraseWifiProfiles(this,function(){console.error("Erasing saved wifi profiles".grey)}),this.once("wifi-profile-erase",function(t){e(+t<0?t:null)})},s.macAddress=function(e){o.macAddress(this,function(){i.info("Requesting MAC Address...".grey)}),this.once("mac-address",function(t){"error"===t.event?e&&e(Error("Unable to retrieve MAC Address. Error Number "+t.status)):e&&e(null,t.mac_address)})},s.configureWifi=function(e,t,n,s,r){function u(){i.info('Connecting to "%s" with %s security...',e,n),function s(){function u(){var e,t;h=!0,i.info("Acquiring IP address. "),e=0,t=c,p=setInterval(function(){++e>=t?(process.stderr.write(" timeout.\n"),i.info("Retrying..."),d(),setTimeout(s,1e3)):process.stderr.write(".")},1e3)}function a(){h&&process.stderr.write("\n"),f.once("wifi-status",function(e){d(),r(e)})}function l(e){d(),r(e)}function d(){null!=p&&clearInterval(p),f.removeListener("wifi-acquire",u),f.removeListener("wifi-dhcp-success",a),f.removeListener("wifi-disconnect",a),f.removeListener("wifi-error",l)}var p=null,h=!1;f.once("wifi-acquire",u),f.once("wifi-dhcp-success",a),f.once("wifi-disconnect",a),f.once("wifi-error",l),o.connect(f,e,t,n)}()}var c,f=this;"function"==typeof s&&(r=s),null==r&&(s={}),c=s.timeout||20,f.once("wifi-status",function(e){e.connected?(i.info("Disconnecting from current network..."),f.once("wifi-disconnect",u),o.disconnect(f)):u()}),f.checkWifi(!0)},s.checkWifi=function(e){o.checkWifi(this,e)},s.deployBundle=function(e,t,s){var r=this;e.length>31457280&&(i.err("Bundle size is %s and is above max limit of %s",n.filesize(e.length),n.filesize(31457280)),process.exit(-1)),r.stop(function(){s&&r.once("script-start",s),t.flash?o.uploadFlash(r,e):o.uploadRam(r,e)})},s.erase=function(e){var t=this;t.stop(function(){o.uploadFlash(t,new Buffer([255,255,255,255]),e)})},s.send=function(e){o.writeProcessMessage(this,e)};