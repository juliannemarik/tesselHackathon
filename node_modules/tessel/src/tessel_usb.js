function e(){}function t(e){this.usb=e,this.mode="boot"}function i(e){this.usb=e,this.mode="app"}function n(e,t){exports.listDevices(function(i,n){for(var o=0;o<n.length;o++)if(!e||e===n[o].serialNumber)return t(n[o].initError,n[o]);return i?t(i):t(null,null)})}var o="MOCK_USB"in process.env?{}:require("usb"),r="MOCK_USB"in process.env?{}:require("../dfu/dfu"),s=require("util"),u=require("async"),c=require("events").EventEmitter,l=(require("semver"),7504),a=o.LIBUSB_REQUEST_TYPE_VENDOR|o.LIBUSB_RECIPIENT_DEVICE|o.LIBUSB_ENDPOINT_OUT,f=o.LIBUSB_REQUEST_TYPE_VENDOR|o.LIBUSB_RECIPIENT_DEVICE|o.LIBUSB_ENDPOINT_IN,p=parseInt(process.env.TESSEL_USB_DEBUG,10);p&&(console.log("USB debug level",p),o.setDebugLevel(p)),s.inherits(e,c),e.prototype.init=function(e){var t=this;try{this.usb.open()}catch(t){return"LIBUSB_ERROR_ACCESS"===t.message&&"linux"===process.platform&&console.error("Please run `sudo tessel install-drivers` to fix device permissions.\n(Error: could not open USB device.)"),e(t)}this.usb.getStringDescriptor(this.usb.deviceDescriptor.iSerialNumber,function(i,n){if(i)return e(i);t.serialNumber=n,e(null,t)})},e.prototype.reFind=function(e,t){function i(){n(o.serialNumber,function(n,o){if(o&&o.mode===e)return t(o.initError,o);if(--r>0)return setTimeout(i,500);var s;return s=n||(o?"In "+o.mode+" mode.":"Device not found."),t("Timed out waiting to switch to "+e+" mode: "+s)})}var o=this,r=16;setTimeout(i,1e3)},s.inherits(t,e),t.prototype.dnload=function(e,t,i,n){var o=new r(this.usb,e);o.claim(function(e){if(e)return i(e);o.dnload(t,i,n)})},t.prototype.runRam=function(e,t,i){this.dnload(1,e,t,i)},t.prototype.writeFlash=function(e,t,i){this.dnload(0,e,t,i)},t.prototype.enterBootloader=function(e){var t=this;setImmediate(function(){e(null,t)})},s.inherits(i,e),exports.Tessel=i,i.prototype.init=function(t){var i=this;this.logLevels=[],e.prototype.init.call(this,function(e){if(e)return t(e);i._info(function(e,n){if(e)return t(e);i.version=n,t(null,i)})})},i.prototype.claim=function(e,t){if("claimed"===this.claimed){if(!e)return setImmediate(t);this.stop(t)}if(this.initCommands(),this.once("claimed",t),!this.claimed){this.claimed="claiming";var i=this;i.intf=i.usb.interface(0);try{i.intf.claim()}catch(e){return"LIBUSB_ERROR_BUSY"===e.message&&(e="Device is in use by another process"),t(e)}e?this.stop(n):n();function n(){i.intf.setAltSetting(1,function(e){if(e)return t(e);i.log_ep=i.intf.endpoints[0],i.msg_in_ep=i.intf.endpoints[1],i.msg_out_ep=i.intf.endpoints[2],i.claimed="claimed",i.usb.timeout=1e4,i._receiveLogs(),i._receiveMessages(),i.emit("claimed")})}}},i.prototype.close=function(e){if(this.closed)return e&&e();this.closed=!0,this.intf.release(!0,function(){this.usb.close(),this.emit("close"),e&&e()}.bind(this))},i.prototype.listen=function(e,t){this.logLevels=t},i.prototype._receiveLogs=function(){var e=this;e.log_ep.startPoll(4,4096),e.log_ep.on("data",function(t){for(var i,n,o,r=0;r<t.length;){if(1!==t[r])throw Error("Expected STX at"+r+" "+t[r]);for(i=t[r+1],n=r+2;n<t.length&&1!==t[n];n++);o=t.toString("utf8",r+2,n),(!e.logLevels&&"array"!=typeof e.logLevels||-1!=e.logLevels.indexOf(i))&&process.stderr.write(o+"\n"),e.emit("log",i,o),r=n}}),e.log_ep.on("error",function(t){e.closed||(console.error("Error reading USB log endpoint:",t),process.exit(-5))})},i.prototype.postMessage=function(e,t,i){var n,o,r;t=t||new Buffer(0),p&&console.log("USB TX: ",t.length,e.toString(16),t),(n=new Buffer(8)).writeUInt32LE(t.length,0),n.writeUInt32LE(e,4),o=Buffer.concat([n,t]),(r=this).msg_out_ep.transferWithZLP(o,function(e){e&&(console.error("Error writing USB message endpoint",e),r.emit("error",e)),i&&i(e)})},i.prototype._receiveMessages=function(){var e,t=this;t.msg_in_ep.startPoll(2,4096),e=[],t.msg_in_ep.on("data",function(i){var n,o,r;if(e.push(i),i.length<4096)(n=Buffer.concat(e)).length>0&&(o=n.readUInt32LE(0),r=n.readUInt32LE(4),n=n.slice(8),p&&console.log("USB RX: ",o,r.toString(16),i),t.emit("rawMessage",r,n),t.emit("rawMessage:"+("0000"+r.toString(16)).slice(-4),n)),e=[];else if(4096*e.length>33554432)throw Error("Malformed message (oversize): "+e[0].toString("hex",0,8))}),t.msg_in_ep.on("error",function(e){t.closed||(console.error("Error reading USB message endpoint:",e),process.exit(-5))})},i.prototype._info=function(e){this.usb.controlTransfer(f,0,0,0,512,function(t,i){if(t)return e(t);e(null,JSON.parse(""+i))})},i.prototype.stop=function(e){this.usb.controlTransfer(a,16,0,0,new Buffer(0),e)},i.prototype.debugstack=function(e){this.usb.controlTransfer(f,17,0,0,16,function(e,t){return e?callNext(e):0!=t.readInt8(0)?callNext(null,!1):void 0}),this.once("debug-stack",function(t){e(null,t)})},i.prototype.wifiIP=function(e){this.usb.controlTransfer(f,32,0,0,4,function(t,i){var n=i[0]+"."+i[1]+"."+i[2]+"."+i[3];if(t)return e(t);e(null,n)})},i.prototype.wifiVer=function(e){this.usb.controlTransfer(f,33,0,0,2,function(t,i){var n=i[0]+"."+i[1];if(t)return e(t);e(null,n)})},exports.findTessel=function(e,t){void 0===e.stop&&(e.stop=!1),void 0===e.serial&&(e.serial=null),void 0===e.claim&&(e.claim=!0),void 0===e.appMode&&(e.appMode=!0),n(e.serial,function(i,n){return i?t(i):n?e.appMode&&"app"!==n.mode?t("An update failed to complete. Press the reset button and try again",null):e.claim&&"app"===n.mode?void n.claim(e.stop,function(e){return e?t(e):t(null,n)}):t(null,n):t(e.serial?"Device matching serial "+e.serial+" not found.":"No devices found.",null)})},exports.listDevices=function(e){var n=o.getDeviceList().map(function(e){if(e.deviceDescriptor.idVendor==l&&24727==e.deviceDescriptor.idProduct)return e.deviceDescriptor.bcdDevice>>8==0?new t(e):new i(e)}).filter(function(e){return e});u.each(n,function(e,t){e.init(function(i){e.initError=i,t(i)})},function(t){e(t,n)})};