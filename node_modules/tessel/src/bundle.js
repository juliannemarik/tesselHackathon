require("net");var e=require("fs"),r=require("path"),n=require("temp"),i=require("colony-compiler"),o=require("async"),t=require("fstream"),c=require("tar"),a=require("effess"),s=require("debug")("tessel"),u=require("../src/logs");!function(){var e=require("tar/lib/header").encode;require("tar/lib/header").encode=function(r){var n=e(r);return r.needExtended=!1,n}}(),exports.bundleFiles=function(t,c,u,f,l){"function"==typeof f&&(l=f,f={}),n.mkdir("colony",function(n,f){var p,d,y,h,m=require("mkdirp");f=r.normalize(f),Object.keys(u).forEach(function(n){m.sync(r.join(f,"app",r.dirname(n))),e.writeFileSync(r.join(f,"app",n),e.readFileSync(u[n],"binary"),"binary")}),p="process.env.DEPLOY_IP = "+JSON.stringify(require("my-local-ip")())+";\nprocess.env.DEPLOY_TIMESTAMP = "+JSON.stringify(Date.now()+"")+";\nprocess.argv = "+JSON.stringify(c)+";\nrequire("+JSON.stringify("./app/"+t.replace("\\","/"))+");",e.writeFileSync(r.join(f,"_start.js"),p),d=[],y=[],a.readdirRecursiveSync(f).forEach(function(e){var n=r.join(f,e);if(e.match(/package\.json$/))try{(h=require(n).noCompile)&&h.length||(h=["/static/"]),h instanceof Array||(h=[h]),y=y.concat(h.map(function(e){return function(n){return r.join(r.dirname(e),n+"/")}}(e)))}catch(e){}}),a.readdirRecursiveSync(f).forEach(function(e){e.match(/\.js$/)&&!y.some(function(e){return function(r){return 0===e.indexOf(r)}}(e))&&d.push([e,r.join(f,e)])}),o.each(d,function(r,n){var o,t,c,a=r[0],u=r[1];s("compiling",a);try{o=e.readFileSync(u,"utf-8"),t=i.colonize(o,{embedLineNumbers:!0})}catch(r){if(!(r instanceof SyntaxError))throw r;c=[r.message,"",e.realpathSync(a.substr(4))+":"+r.loc.line,o.split(/\n/)[r.loc.line-2]||"",Array(r.loc.column||0).join(" ")+"^"].join("\n"),t=i.colonize("throw new SyntaxError("+JSON.stringify(c)+")",{embedLineNumbers:!0})}e.writeFileSync(u,t.source),n(null)},function(){exports.tarCode(f,"",l)})})},exports.tarCode=function(e,r,n){var i,o,a=t.Reader({path:e,type:"Directory"});a.basename="",a.on("entry",function(e){e.root={path:e.path}}),a.on("error",function(e){u.err("Error bundling code archive: "+e),process.exit(1)}),i=[],(o=c.Pack())._noProprietary=!0,a.pipe(o).on("data",function(e){i.push(e)}).on("end",function(){var e=Buffer.concat(i),r=!1,o=c.Parse().on("entry",function(e){"_start.js"==e.path&&(r=!0)}).on("end",function(){r||(u.err("Command line generated bundle without an /_start.js file. Please report this error."),process.exit(1)),n(null,e)});o.write(e),o.end()}).on("error",function(e){u.err("Error in compressing code archive: "+e),process.exit(1)})};