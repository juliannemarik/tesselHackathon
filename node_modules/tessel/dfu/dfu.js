function t(t,e){var r,n,i;for(this.device=t,this.device.open(),this.device.timeout=1e4,this.altsetting=e||0,r=!1,n=0;n<this.device.interfaces.length;n++)if(254==(i=this.device.interfaces[n].descriptor).bInterfaceClass&&1==i.bInterfaceSubClass){if(r=!0,this.bInterface=i.bInterfaceNumber,this.iface=this.device.interfaces[n],33!=i.extra[1])throw Error("DFU functional descriptor is invalid");this.canDownload=!!(1&i.extra[2]),this.canUpload=!!(2&i.extra[2]),this.manifestationTolerant=!!(2&i.extra[2]),this.detachTimeOut=i.extra.readUInt16LE(3),this.transferSize=i.extra.readUInt16LE(5);break}if(!r)throw Error("No DFU interface found!")}require("usb");var e=require("assert");t.prototype.claim=function(t){this.iface.claim(),this.iface.setAltSetting(this.altsetting,t)},t.prototype.getStatus=function(t){this.device.controlTransfer(161,3,0,this.bInterface,6,function(e,r){if(e)return t(e);t(null,{status:r[0],pollTime:r[1]<<0|r[2]<<8|r[3]<<16,state:r[4],iString:r[5]})})},t.prototype.clearStatus=function(t){this.device.controlTransfer(33,4,0,this.bInterface,0,t)},t.prototype.abort=function(t){this.device.controlTransfer(33,6,0,this.bInterface,0,t)},t.prototype.dnloadChunk=function(t,r,n){e(r.length<=this.transferSize),this.device.controlTransfer(33,1,t,this.bInterface,r,n)},t.prototype.dnload=function(t,e,r){function n(){r&&r(o,t.length),i.dnloadChunk(s,t.slice(o,o+i.transferSize),function(a){if(a&&(console.log("chunk error",a),a))return i.handleError(a,e);i.getStatus(function(a){if(a)return console.log("status error",a),e(a);s+=1,(o+=i.transferSize)<t.length?n():(r&&r(t.length,t.length),i.dnloadChunk(s,new Buffer(0),function(t){if(t)return e(t);i.getStatus(function(t){if(t)return e(t);setTimeout(e,100)})}))})})}var i=this,o=0,s=0;n()},t.prototype.uploadChunk=function(t,e,r){this.device.controlTransfer(161,2,t,this.bInterface,e,r)},t.prototype.upload=function(t){function e(){r.uploadChunk(i,r.transferSize,function(o,s){if(o)return r.handleError(o,t);n.push(s),s.length==r.transferSize?(i+=1,e()):t(null,Buffer.concat(n))})}var r=this,n=[],i=0;e()},t.prototype.handleError=function(t,e){(t.errno=4)?this.getStatus(function(r,n){if(r)return console.log("status error",r),r.previous=t,e(r);t.status=n,console.log("status after error",n),e(t)}):e(t)},module.exports=t;