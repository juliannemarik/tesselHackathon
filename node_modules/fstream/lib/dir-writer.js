function r(t){this instanceof r||this.error("DirWriter must be called as constructor.",null,!0),"Directory"===t.type&&t.Directory||this.error("Non-directory type "+t.type+" "+JSON.stringify(t),null,!0),e.call(this,t)}module.exports=r,require("graceful-fs"),require("../fstream.js");var e=require("./writer.js"),t=require("inherits"),i=require("mkdirp"),o=require("path"),n=require("./collect.js");t(r,e),r.prototype._create=function(){var r=this;i(r._path,e.dirmode,function(e){if(e)return r.error(e);r.ready=!0,r.emit("ready"),r._process()})},r.prototype.write=function(){return!0},r.prototype.end=function(){this._ended=!0,this._process()},r.prototype.add=function(r){return n(r),!this.ready||this._currentEntry?(this._buffer.push(r),!1):this._ended?this.error("add after end"):(this._buffer.push(r),this._process(),0===this._buffer.length)},r.prototype._process=function(){var r,t,i,n,s,p,h=this;if(!h._processing){if(!(r=h._buffer.shift()))return h.emit("drain"),void(h._ended&&h._finish());h._processing=!0,h.emit("entry",r),t=r;do{if((i=t._path||t.path)===h.root._path||i===h._path||i&&0===i.indexOf(h._path))return h._processing=!1,r._collected&&r.pipe(),h._process()}while(t=t.parent);n={parent:h,root:h.root||h,type:r.type,depth:h.depth+1},t=r._path||r.path||r.props.path,r.parent&&(t=t.substr(r.parent._path.length+1)),n.path=o.join(h.path,o.join("/",t)),n.filter=h.filter,Object.keys(r.props).forEach(function(e){n.hasOwnProperty(e)||(n[e]=r.props[e])}),(s=h._currentChild=new e(n)).on("ready",function(){r.pipe(s),r.resume()}),s.on("error",function(r){s._swallowErrors?(h.warn(r),s.emit("end"),s.emit("close")):h.emit("error",r)}),s.on("close",function(){p||(p=!0,h._currentChild=null,h._processing=!1,h._process())}),p=!1}};