function e(t){if(!(this instanceof e))throw Error("DirReader must be called as constructor.");if("Directory"!==t.type||!t.Directory)throw Error("Non-directory type "+t.type);this.entries=null,this._index=-1,this._paused=!1,this._length=-1,t.sort&&(this.sort=t.sort),r.call(this,t)}module.exports=e;var t=require("graceful-fs"),r=require("../fstream.js").Reader,n=require("inherits"),i=(require("mkdirp"),require("path")),r=require("./reader.js"),s=require("assert").ok;n(e,r),e.prototype._getEntries=function(){var e=this;e._gotEntries||(e._gotEntries=!0,t.readdir(e._path,function(t,r){function n(){e._length=e.entries.length,"function"==typeof e.sort&&(e.entries=e.entries.sort(e.sort.bind(e))),e._read()}if(t)return e.error(t);e.entries=r,e.emit("entries",r),e._paused?e.once("resume",n):n()}))},e.prototype._read=function(){var e,n=this;if(!n.entries)return n._getEntries();n._paused||n._currentEntry||n._aborted||(n._index++,n._index>=n.entries.length?n._ended||(n._ended=!0,n.emit("end"),n.emit("close")):(e=i.resolve(n._path,n.entries[n._index]),s(e!==n._path),s(n.entries[n._index]),n._currentEntry=e,t[n.props.follow?"stat":"lstat"](e,function(t,s){function o(){h||(h=!0,n.emit("childEnd",d),n.emit("entryEnd",d),n._currentEntry=null,n._paused||n._read())}var u,a,d,h;if(t)return n.error(t);u=n._proxy||n,s.path=e,s.basename=i.basename(e),s.dirname=i.dirname(e),(a=n.getChildProps.call(u,s)).path=e,a.basename=i.basename(e),a.dirname=i.dirname(e),d=r(a,s),n._currentEntry=d,d.on("pause",function(e){n._paused||d._disowned||n.pause(e)}),d.on("resume",function(e){n._paused&&!d._disowned&&n.resume(e)}),d.on("stat",function(e){n.emit("_entryStat",d,e),d._aborted||(d._paused?d.once("resume",function(){n.emit("entryStat",d,e)}):n.emit("entryStat",d,e))}),d.on("ready",function e(){if(n._paused)return d.pause(n),n.once("resume",e);"Socket"===d.type?n.emit("socket",d):n.emitEntry(d)}),h=!1,d.on("close",o),d.on("disown",o),d.on("error",function(e){d._swallowErrors?(n.warn(e),d.emit("end"),d.emit("close")):n.emit("error",e)}),["child","childEnd","warn"].forEach(function(e){d.on(e,n.emit.bind(n,e))})})))},e.prototype.disown=function(e){e.emit("beforeDisown"),e._disowned=!0,e.parent=e.root=null,e===this._currentEntry&&(this._currentEntry=null),e.emit("disown")},e.prototype.getChildProps=function(){return{depth:this.depth+1,root:this.root||this,parent:this,follow:this.follow,filter:this.filter,sort:this.props.sort,hardlinks:this.props.hardlinks}},e.prototype.pause=function(e){this._paused||(e=e||this,this._paused=!0,this._currentEntry&&this._currentEntry.pause&&this._currentEntry.pause(e),this.emit("pause",e))},e.prototype.resume=function(e){this._paused&&(e=e||this,this._paused=!1,this.emit("resume",e),this._paused||(this._currentEntry?this._currentEntry.resume&&this._currentEntry.resume(e):this._read()))},e.prototype.emitEntry=function(e){this.emit("entry",e),this.emit("child",e)};