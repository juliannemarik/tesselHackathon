function e(t){var r=this;if(!(r instanceof e))return new e(t);r._noProprietary=!!t&&t.noProprietary,r._global=t,r.readable=!0,r.writable=!0,r._buffer=[],r._currentEntry=null,r._processing=!1,r._pipeRoot=null,r.on("pipe",function(e){e.root!==r._pipeRoot&&(r._pipeRoot=e,e.on("end",function(){r._pipeRoot=null}),r.add(e))})}var t,r,i,n,o,s,a,p;for(module.exports=e,t=require("./entry-writer.js"),r=require("stream").Stream,i=require("path"),n=require("inherits"),o=require("./global-header-writer.js"),s=require("fstream").collect,a=new Buffer(512),p=0;p<512;p++)a[p]=0;n(e,r),e.prototype.addGlobal=function(e){if(!this._didGlobal){this._didGlobal=!0;var t=this;o(e).on("data",function(e){t.emit("data",e)}).end()}},e.prototype.add=function(e){return this._global&&!this._didGlobal&&this.addGlobal(this._global),this._ended?this.emit("error",Error("add after end")):(s(e),this._buffer.push(e),this._process(),this._needDrain=this._buffer.length>0,!this._needDrain)},e.prototype.pause=function(){this._paused=!0,this._currentEntry&&this._currentEntry.pause(),this.emit("pause")},e.prototype.resume=function(){this._paused=!1,this._currentEntry&&this._currentEntry.resume(),this.emit("resume"),this._process()},e.prototype.end=function(){this._ended=!0,this._buffer.push(a),this._process()},e.prototype._process=function(){function e(){u||(u=!0,c._currentEntry=null,c._processing=!1,c._process())}var r,n,o,s,p,u,c=this;if(!c._paused&&!c._processing)if(r=c._buffer.shift()){if(!1===r.ready)return c._buffer.unshift(r),void r.on("ready",function(){c._process()});if(c._processing=!0,r===a)return c.emit("data",a),c.emit("data",a),c.emit("end"),void c.emit("close");switch(n=i.dirname((r.root||r).path),o={},Object.keys(r.props||{}).forEach(function(e){o[e]=r.props[e]}),c._noProprietary&&(o.noProprietary=!0),o.path=i.relative(n,r.path||""),"win32"===process.platform&&(o.path=o.path.replace(/\\/g,"/")),o.type||(o.type="Directory"),o.type){case"Socket":return;case"Directory":o.path+="/",o.size=0;break;case"Link":s=i.resolve(i.dirname(r.path),r.linkpath),o.linkpath=i.relative(n,s)||".",o.size=0;break;case"SymbolicLink":s=i.resolve(i.dirname(r.path),r.linkpath),o.linkpath=i.relative(i.dirname(r.path),s)||".",o.size=0}(p=c._currentEntry=t(o)).parent=c,p.on("data",function(e){c.emit("data",e)}),p.on("header",function(){Buffer.prototype.toJSON=function(){return(""+this).split(/\0/).join(".")},0===p.props.size&&e()}),p.on("close",e),u=!1,p.on("error",function(e){c.emit("error",e)}),r===c._pipeRoot&&(p.add=null),r.pipe(p)}else c._needDrain&&c.emit("drain")},e.prototype.destroy=function(){},e.prototype.write=function(){};