function e(){}function n(e){var n=[];n.id=e,n.hoist=[],n.flow=[],b=n.flow,d.unshift(n)}function t(e){b[0]&&"label"==b[0].type?b[0].type=e:b.unshift({type:e,usesContinue:!1})}function r(e){b.unshift({type:"label",label:e,usesContinue:!1})}function i(e,n,t){this.type=e,this.start=n,this.str=t}function o(n,t){return e(),new i(n.type,n.start,t)}function a(e){return e+="",-1==["undefined","arguments"].indexOf(e)?x.indexOf(e)>-1?"_K_"+e:e.replace(/_/g,"__").replace(/\$/g,"_S").replace(/[\u0080-\uFFFF]/g,function(e){return"_"+("0000"+e.charCodeAt(0)).slice(-4)}):e}function u(e){return"Identifier"==e.type?o(e,a(e+"")):e}function l(e){var n,t,r,i;if("AssignmentExpression"==e.type){for(n=""+e;n.match(/\[[^\[\]]*\]/);)n=n.replace(/\[[^\[\]]*\]/g,function(e){return e.replace(/./g," ")});for(;n.match(/\([^\(\)]*\)/);)n=n.replace(/\([^\(\)]*\)/g,function(e){return e.replace(/./g," ")});return t=n.split(/=\s*/,2),r=e.substr(0,t[0].length),i=e.substr(t[0].length+1),o(e,"(function () local _r = "+i+"; "+r+" = _r; return _r; end)()")}return"UpdateExpression"==e.type?o(e,"(function () "+e+"; return _r; end)()"):e}function s(e){return["AssignmentExpression","UpdateExpression","CallExpression"].indexOf(e.type)>-1?o(e,e+";"):o(e,"if "+e.replace(/;?$/,"")+" then end;")}function c(e){return(e||[]).map(function(e){return"--[["+(O?y[e.start]+1:e.start)+"]] "+("BlockStatement"==e.type?c(e.body):e)}).join("\n")}function f(n,t){var r,i,f,p,y,g,x,O,C,F,N,L,D,q,A,B,J,G,U,M,$;if(e(),"Identifier"==t)return"arguments"==n.name&&(d[0].arguments=!0),r=o(n,n.name),r.name=n.name,r;if("Literal"==t)return n.value instanceof RegExp?(i=h.push("_regexp("+JSON.stringify(n.value.source)+", "+JSON.stringify((n.value+"").replace(/^.*\//,""))+")"),o(n,"_regex"+(i-1))):"string"==typeof n.value?o(n,'("'+(n.value.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'")').replace(/[^\u0020-\u007E]/g,function(e){var n,t;return n=m?Buffer(e):(t=e.charCodeAt(0))<128?[t]:t<2048?[192|t>>>6,128|63&t]:t<65536?[224|t>>>12,128|t>>>6&63,128|63&t]:t<1114112?[240|t>>>18,128|t>>>12&63,128|t>>>6&63,128|63&t]:[239,191,189],Array.prototype.map.call(n,function(e){return"\\"+("000"+e).substr(-3)}).join("")})):"number"==typeof n.value?o(n,"("+JSON.stringify(n.value)+")"):o(n,"("+n.raw+")");if("MemberExpression"==t)return n.computed?o(n,l(u(n.object))+"["+l(u(n.property))+"]"):a(n.property+"")!=n.property+""?o(n,l(u(n.object))+"["+JSON.stringify(n.property+"")+"]"):o(n,l(u(n.object))+"."+n.property);if("AssignmentExpression"==t)return"="!=n.operator&&(f=n.operator.slice(0,-1),n.right=f in w?w[f]+"(("+l(u(n.left))+"), ("+l(u(n.right))+"))":f in E?E[f]+"(_G.tointegervalue("+l(u(n.left))+"), _G.tointegervalue("+l(u(n.right))+"))":u(n.left)+f+l(u(n.right))),o(n,u(n.left)+" = "+l(u(n.right)));if("CallExpression"==t){if("MemberExpression"==n.callee.type&&(n.callee+"").match(/\]$/)){for(p=0,y=n.callee+"",g=0,i=0;i<y.length;i++)"["==y[i]?(0==g&&(p=i),g++):"]"==y[i]&&g--;return x=y.substr(0,p),O=y.slice(p+1,-1),o(n,"(function () local _b = "+x+"; local _f = _b["+O+"]; return _f("+["_b"].concat(n.arguments.map(u).map(l)).join(", ")+"); end)()")}return C="MemberExpression"==n.callee.type,o(n,(C?u(n.callee).replace(/^([\s\S]+)\./,"$1:"):l(u(n.callee)))+"("+(C?[]:["_global"]).concat(n.arguments.map(u).map(l)).join(", ")+")")}if("NewExpression"==t)return o(n,"_new("+[l(u(n.callee))].concat(n.arguments.map(u).map(l)).join(", ")+")");if("ThisExpression"==t)return o(n,"this");if("UpdateExpression"==t)return n.prefix?o(n,"local _r = "+u(n.argument)+" "+n.operator.substr(0,1)+" 1; "+u(n.argument)+" = _r"):o(n,"local _r = "+u(n.argument)+"; "+u(n.argument)+" = _r "+n.operator.substr(0,1)+" 1");if("ConditionalExpression"==t)return o(n,"(("+l(u(n.test))+") and {"+l(u(n.consequent))+"} or {"+l(u(n.alternate))+"})[1]");if("UnaryExpression"==t)return"delete"==n.operator?o(n,"(function () local _r = "+u(n.argument)+"; "+u(n.argument)+" = nil; return _r ~= nil; end)()"):o(n,"("+(S[n.operator]||n.operator)+"("+l(u(n.argument))+"))");if("LogicalExpression"==t)return o(n,"(("+l(u(n.left))+")"+k[n.operator]+"("+l(u(n.right))+"))");if("BinaryExpression"==t)return n.operator in E?o(n,E[n.operator]+"(_G.tointegervalue("+l(u(n.left))+"),_G.tointegervalue("+l(u(n.right))+"))"):n.operator in w?o(n,w[n.operator]+"(("+l(u(n.left))+"),("+l(u(n.right))+"))"):o(n,"(("+l(u(n.left))+")"+(v[n.operator]||n.operator)+"("+l(u(n.right))+"))");if("ArrayExpression"==t){function I(e){return e||o({type:"Literal",value:null,raw:"null"},"nil")}return o(n,"_arr({"+[n.elements.length>0?"[0]="+l(u(I(n.elements[0]))):""].concat(n.elements.slice(1).map(I).map(u).map(l)).join(", ")+"}, "+n.elements.length+")")}if("ObjectExpression"==t)return F={},N="_obj({\n  "+n.properties.filter(function(e){return"init"!=e.kind&&((F[e.key]||(F[e.key]={}))[e.kind]=e),"init"==e.kind}).map(function(e){return"["+("Literal"==e.key.type?e.key:JSON.stringify(""+e.key))+"]="+l(u(e.value))}).join(",\n  ")+"\n})",Object.keys(F).length&&(N="(function () local _r = "+N+"; "+Object.keys(F).map(function(e){return"Object:defineProperty(_r, "+JSON.stringify(e)+", {"+Object.keys(F[e]).map(function(n){return n+" = "+F[e][n].value}).join(", ")+"}); "}).join(" ")+" return _r; end)()"),o(n,N);if("SequenceExpression"==t)return o(n,"_seq({"+n.expressions.map(function(e){return l(u(e))}).join(", ")+"})");if("IfStatement"==t)return o(n,"if "+l(u(n.test))+" then\n"+(n.consequent.body?c(n.consequent.body):n.consequent)+"\n"+(n.alternate?"else\n"+(n.alternate.body?c(n.alternate.body):n.alternate)+"\n":"")+"end;");if("ReturnStatement"==t)return o(n,"if true then return "+(n.argument?l(u(n.argument)):"")+"; end");if("ForInStatement"==t)return L=b.shift(),D=a("var"==n.left.kind?n.left.declarations[0].str.replace(/\s*=.*$/,""):n.left),o(n,["for "+D+" in _pairs("+l(u(n.right))+") do ",D+' = ""+'+D+"; ",n.body.body?c(n.body.body):n.body,"end;"].join("\n"));if("ExpressionStatement"==t)return r=s(n.expression),r.expression=n.expression,r;if("VariableDeclarator"==t)return d[0].push(u(n.id)),o(n,u(n.id)+" = "+(n.init?l(u(n.init)):"nil")+"; ");if("VariableDeclaration"==t)return o(n,n.declarations.join(" "));if("WithStatement"==t)return i=function(e){return _.push(e)}(c(n.body.body)),o(n,"local _ret = _with("+n.object+", _G._with_fn"+i+");if _ret ~= _with then return _ret end; ");if("SwitchCase"==t)return n;if("SwitchStatement"==t)return L=b.shift(),q="\n",o(n,["repeat",n.cases.map(function(e,n){return"local _"+n+(e.test?" = "+l(u(e.test)):"")+";"}).join(" "),"local _r = "+l(u(n.discriminant))+";",n.cases.map(function(e,t){return e.test?"if _r == _"+t+" then"+q+e.consequent.map(function(e){return"BlockStatement"==e.type?c(e.body):e}).join(q)+q+(t<n.cases.length-1&&"BreakStatement"!=(e.consequent.slice(-1)[0]||{}).type?"_r = _"+(t+1)+";"+q:"")+"end":e.consequent.join(q)}).join(q),"until true"].join(q));if("BlockStatement"==t)return n;if("EmptyStatement"==t||"DebuggerStatement"==t)return o(n,"");if("WhileStatement"==t)return L=b.shift(),A=b.filter(function(e){return"try"!=e.type&&e.label}).map(function(e){return e.label}).reverse(),o(n,["while "+u(l(n.test))+" do ",L.usesContinue?"local _c"+(L.label||"")+" = nil; repeat":"",n.body.body?c(n.body.body):n.body,L.usesContinue?"until true;\nif _c"+L.label+" == _break"+[""].concat(A).join(" or _c")+" then break end;":"","end;"].join("\n"));if("DoWhileStatement"==t)return L=b.shift(),A=b.filter(function(e){return"try"!=e.type&&e.label}).map(function(e){return e.label}).reverse(),o(n,["repeat ",L.usesContinue?"local _c"+(L.label||"")+" = nil; repeat":"",n.body.body?c(n.body.body):n.body,L.usesContinue?"until true;\nif _c"+L.label+" == _break"+[""].concat(A).join(" or _c")+" then break end;":"","until not ("+u(l(n.test))+"); "].join("\n"));if("ForStatement"==t)return L=b.shift(),o(n,[n.init?n.init.declarations?n.init.declarations.join(" "):s(u(n.init)):"","while "+(n.test?u(l(n.test)):"true")+" do ",L.usesContinue?"local _c = nil; repeat":"",n.body.body?c(n.body.body):n.body,L.usesContinue?"until true;\nif _c == _break then break end;":"",n.update?s(n.update):"","end;"].join("\n"));if("TryStatement"==t)return L=b.shift(),o(n,["local _e, _noreturn = nil, {}","local _s, _r = _xpcall(function ()",n.block.body?c(n.block.body):"","      if true then return _noreturn; end","    end, function (err)","        _e = err","    end);"].concat(n.handler?["if _s == false then",a(n.handler.param)+" = _e;","_r = (function ()",n.handler.body?c(n.handler.body.body):"","  if true then return _noreturn; end","end)();","end;"]:[]).concat([n.finalizer?c(n.finalizer.body):""]).concat(n.handler?[]:["if _s == false then","_error(_e)","end"]).concat(b.length?["if _r == _break then",b.length&&"try"==b[0].type?"return _break;":"break;","elseif _r == _cont then",b.length&&"try"==b[0].type?"return _cont;":"break;","elseif _r ~= _noreturn then","  return _r","end;"]:["if _r ~= _noreturn then","  return _r","end;"]).join("\n"));if("BreakStatement"==t)return o(n,(b[0].usesContinue?"_c"+(n.label||b[0].label||"")+" = _break; ":"")+"if true then "+("try"==(b[0]||{}).type?"return _break;":"break;")+" end;");if("ContinueStatement"==t)return b.some(function(e){if(e.usesContinue=!0,e.label+""==n.label+""||!n.label)return!0}),o(n,"_c"+(n.label||"")+" = _cont; if true then "+("try"==b[0].type?"return _cont;":"break;")+" end;");if("ThrowStatement"==t)return o(n,"_error("+u(n.argument)+" or {})");if("CatchClause"==t)return n;if("LabeledStatement"==t)return o(n.body,"repeat "+c(n.body.body)+" until false;");if("FunctionExpression"==t||"FunctionDeclaration"==t)return B=d[0].length?"local "+d[0].join(", ")+" = "+d[0].join(", ")+";\n":"",J=!!d[0].arguments,G=d[0].hoist.join("\n"),d.shift(),b=d[0].flow,"FunctionDeclaration"==t&&d[0].push(a(n.id)),U=o(n,("FunctionDeclaration"==t?n.id?a(n.id)+" = ":"":"(")+(n.id?"(function () local "+a(n.id)+" = nil; "+a(n.id)+" = ":"")+"function ("+(J?"this, ...)\n"+(n.params.length?"local "+n.params.map(a).join(", ")+" = ...;\n":"")+"local arguments = _arguments(...);\n":["this"].concat(n.params.map(a)).join(", ")+")\n")+B+G+c(n.body.body)+"\nend"+(n.id?"; "+a(n.id)+':__defineGetter__("name", function () return '+JSON.stringify(a(n.id))+"; end); return "+a(n.id)+"; end)()":"")+("FunctionDeclaration"==t?";\n":")")),"FunctionDeclaration"==t?(d[0].hoist.push(U),o(n,"")):U;if("Program"==t)return M="",_.forEach(function(e,n){M+="function _with_fn"+(n+1)+"(_with)\n"+e+"\nreturn _with;\nend\n"}),B=d[0].length?"local "+d[0].join(", ")+" = "+d[0].join(", ")+";\n":"",G=d[0].hoist.join("\n"),d.shift(),h.forEach(function(e,n){B+="local _regex"+n+" = "+e+";\n"}),$="",j&&n.body.length&&n.body[n.body.length-1].expression&&($="\nif true then return "+l(n.body.pop().expression)+"; end"),o(n,M+"\n--[[COLONY_MODULE]]\n"+B+G+c(n.body)+$);throw Error("Colony cannot yet handle type "+t)}function p(e,i){var o,a,u,l,s,c,b,m,x,S;for(j=(i||{}).returnLastStatement,O=!!(i||{}).embedLineNumbers,o=!1!==(i||{}).wrap,e=e.replace(/^\#\!/,"//#!"),y=Array(e.length),a=0,u=0;a<e.length;a++)"\n"==e[a]&&u++,y[a]=u;try{d=[],_=[],h=[],n(null),l=g.parse(e,{ecmaVersion:5,allowReturnOutsideFunction:!0,behaviors:{openFor:t.bind(null,"for"),openTry:t.bind(null,"try"),openWhile:t.bind(null,"while"),openSwitch:t.bind(null,"switch"),openLabel:r,openFunction:n,closeNode:f}})}catch(n){if(!(n instanceof SyntaxError))throw n;return s=[n.message,"",((i||{}).path||"(user script)")+":"+n.loc.line,e.split(/\n/)[n.loc.line-1]||"",Array(n.loc.column||0).join(" ")+"^"].join("\n"),p("throw new SyntaxError("+JSON.stringify(s)+")")}return c=l.replace(/--\[\[COLONY_MODULE\]\][\s\S]*$/,""),b=l.replace(/^[\s\S]*--\[\[COLONY_MODULE\]\]/,""),o?(m=[c,"return function (_ENV, _module)\nlocal exports, module = _module.exports, _module;\n",b,"\nreturn _module.exports;\nend "].join("\n"),x=0,S=m.match(/^(\-\-\[\[[^\]]+)?/gm).map(function(e){return e.length&&(x=parseInt(e.slice(4))),y[x]}),{source:m,sourcemap:S}):c+"\n"+b}var d,b,_,h,y,m,g=require("./acorn_mod"),j=!1,x=["and","break","do","else","elseif","end","false","for","function","if","in","local","nil","not","or","repeat","return","then","true","until","while"],S={"|":"_bit.bor","&":"_bit.band","~":"_bit.bnot","+":"_G.tonumbervalue","!":"not ",typeof:"_typeof",void:"_void"},k={"&&":"and","||":"or"},E={"|":"_bit.bor","&":"_bit.band","|":"_bit.bor",">>":"_bit.arshift","<<":"_bit.lshift",">>>":"_bit.rshift","^":"_bit.bxor"},w={instanceof:"_instanceof",in:"_in"},v={"!==":"~=","!=":"~=","===":"=="},O=!1;(i.prototype=new String).valueOf=function(){return this.str},i.prototype.toString=function(){return this.str},m=237===Buffer("\ud800")[0],module.exports=p;