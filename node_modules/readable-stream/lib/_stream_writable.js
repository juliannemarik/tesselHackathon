"use strict";function e(e){var t=this;this.next=null,this.entry=null,this.finish=function(){!function(e,t){var n,r=e.entry;for(e.entry=null;r;)n=r.callback,t.pendingcb--,n(void 0),r=r.next;t.corkedRequestsFree?t.corkedRequestsFree.next=e:t.corkedRequestsFree=e}(t,e)}}function t(){}function n(t,n){var r,i,u,l,h;d=d||require("./_stream_duplex"),t=t||{},r=n instanceof d,this.objectMode=!!t.objectMode,r&&(this.objectMode=this.objectMode||!!t.writableObjectMode),i=t.highWaterMark,u=t.writableHighWaterMark,l=this.objectMode?16:16384,this.highWaterMark=i||0===i?i:r&&(u||0===u)?u:l,this.highWaterMark=Math.floor(this.highWaterMark),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1,h=!1===t.decodeStrings,this.decodeStrings=!h,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var n,r=e._writableState,i=r.sync,u=r.writecb;!function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(r),t?function(e,t,n,r,i){--t.pendingcb,n?(k.nextTick(i,r),k.nextTick(c,e,t),e._writableState.errorEmitted=!0,e.emit("error",r)):(i(r),e._writableState.errorEmitted=!0,e.emit("error",r),c(e,t))}(e,r,i,t,u):((n=f(r))||r.corked||r.bufferProcessing||!r.bufferedRequest||s(e,r),i?a(o,e,r,n,u):o(e,r,n,u))}(n,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new e(this)}function r(e){if(d=d||require("./_stream_duplex"),!(g.call(r,this)||this instanceof d))return new r(e);this._writableState=new n(e,this),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.final&&(this._final=e.final)),b.call(this)}function i(e,t,n,r,i,o,s){t.writelen=r,t.writecb=s,t.writing=!0,t.sync=!0,n?e._writev(i,t.onwrite):e._write(i,o,t.onwrite),t.sync=!1}function o(e,t,n,r){n||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,r(),c(e,t)}function s(t,n){var r,o,s,f,u,c,a,d,l,h;if(n.bufferProcessing=!0,r=n.bufferedRequest,t._writev&&r&&r.next){for(o=n.bufferedRequestCount,s=Array(o),(f=n.corkedRequestsFree).entry=r,u=0,c=!0;r;)s[u]=r,r.isBuf||(c=!1),r=r.next,u+=1;s.allBuffers=c,i(t,n,!0,n.length,s,"",f.finish),n.pendingcb++,n.lastBufferedRequest=null,f.next?(n.corkedRequestsFree=f.next,f.next=null):n.corkedRequestsFree=new e(n),n.bufferedRequestCount=0}else{for(;r&&(a=r.chunk,d=r.encoding,l=r.callback,h=n.objectMode?1:a.length,i(t,n,!1,h,a,d,l),r=r.next,n.bufferedRequestCount--,!n.writing););null===r&&(n.lastBufferedRequest=null)}n.bufferedRequest=r,n.bufferProcessing=!1}function f(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function u(e,t){e._final(function(n){t.pendingcb--,n&&e.emit("error",n),t.prefinished=!0,e.emit("prefinish"),c(e,t)})}function c(e,t){var n=f(t);return n&&(function(e,t){t.prefinished||t.finalCalled||("function"==typeof e._final?(t.pendingcb++,t.finalCalled=!0,k.nextTick(u,e,t)):(t.prefinished=!0,e.emit("prefinish")))}(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"))),n}var a,d,l,h,b,p,w,y,g,k=require("process-nextick-args");module.exports=r,a=!process.browser&&["v0.10","v0.9."].indexOf(process.version.slice(0,5))>-1?setImmediate:k.nextTick,r.WritableState=n,(l=require("core-util-is")).inherits=require("inherits"),h={deprecate:require("util-deprecate")},b=require("./internal/streams/stream"),p=require("safe-buffer").Buffer,w=global.Uint8Array||function(){},y=require("./internal/streams/destroy"),l.inherits(r,b),n.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(n.prototype,"buffer",{get:h.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(g=Function.prototype[Symbol.hasInstance],Object.defineProperty(r,Symbol.hasInstance,{value:function(e){return!!g.call(this,e)||this===r&&e&&e._writableState instanceof n}})):g=function(e){return e instanceof this},r.prototype.pipe=function(){this.emit("error",Error("Cannot pipe, not readable"))},r.prototype.write=function(e,n,r){var o=this._writableState,s=!1,f=!o.objectMode&&function(e){return p.isBuffer(e)||e instanceof w}(e);return f&&!p.isBuffer(e)&&(e=function(e){return p.from(e)}(e)),"function"==typeof n&&(r=n,n=null),f?n="buffer":n||(n=o.defaultEncoding),"function"!=typeof r&&(r=t),o.ended?function(e,t){var n=Error("write after end");e.emit("error",n),k.nextTick(t,n)}(this,r):(f||function(e,t,n,r){var i=!0,o=!1;return null===n?o=new TypeError("May not write null values to stream"):"string"==typeof n||void 0===n||t.objectMode||(o=new TypeError("Invalid non-string/buffer chunk")),o&&(e.emit("error",o),k.nextTick(r,o),i=!1),i}(this,o,e,r))&&(o.pendingcb++,s=function(e,t,n,r,o,s){var f,u,c,a;return n||r!==(f=function(e,t,n){return e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=p.from(t,n)),t}(t,r,o))&&(n=!0,o="buffer",r=f),u=t.objectMode?1:r.length,t.length+=u,(c=t.length<t.highWaterMark)||(t.needDrain=!0),t.writing||t.corked?(a=t.lastBufferedRequest,t.lastBufferedRequest={chunk:r,encoding:o,isBuf:n,callback:s,next:null},a?a.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1):i(e,t,!1,u,r,o,s),c}(this,o,f,e,n,r)),s},r.prototype.cork=function(){this._writableState.corked++},r.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.bufferedRequest||s(this,e))},r.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+e);return this._writableState.defaultEncoding=e,this},Object.defineProperty(r.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),r.prototype._write=function(e,t,n){n(Error("_write() is not implemented"))},r.prototype._writev=null,r.prototype.end=function(e,t,n){var r=this._writableState;"function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!==e&&void 0!==e&&this.write(e,t),r.corked&&(r.corked=1,this.uncork()),r.ending||r.finished||function(e,t,n){t.ending=!0,c(e,t),n&&(t.finished?k.nextTick(n):e.once("finish",n)),t.ended=!0,e.writable=!1}(this,r,n)},Object.defineProperty(r.prototype,"destroyed",{get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),r.prototype.destroy=y.destroy,r.prototype._undestroy=y.undestroy,r.prototype._destroy=function(e,t){this.end(),t(e)};