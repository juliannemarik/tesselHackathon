"use strict";function t(e){if(!(this instanceof t))return new t(e);n.call(this,e),this._transformState={afterTransform:function(t,r){var e,n,i=this._transformState;if(i.transforming=!1,!(e=i.writecb))return this.emit("error",Error("write callback called multiple times"));i.writechunk=null,i.writecb=null,null!=r&&this.push(r),e(t),(n=this._readableState).reading=!1,(n.needReadable||n.length<n.highWaterMark)&&this._read(n.highWaterMark)}.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",r)}function r(){var t=this;"function"==typeof this._flush?this._flush(function(r,n){e(t,r,n)}):e(this,null,null)}function e(t,r,e){if(r)return t.emit("error",r);if(null!=e&&t.push(e),t._writableState.length)throw Error("Calling transform done when ws.length != 0");if(t._transformState.transforming)throw Error("Calling transform done when still transforming");return t.push(null)}var n,i;module.exports=t,n=require("./_stream_duplex"),(i=require("core-util-is")).inherits=require("inherits"),i.inherits(t,n),t.prototype.push=function(t,r){return this._transformState.needTransform=!1,n.prototype.push.call(this,t,r)},t.prototype._transform=function(){throw Error("_transform() is not implemented")},t.prototype._write=function(t,r,e){var n,i=this._transformState;i.writecb=e,i.writechunk=t,i.writeencoding=r,i.transforming||(n=this._readableState,(i.needTransform||n.needReadable||n.length<n.highWaterMark)&&this._read(n.highWaterMark))},t.prototype._read=function(){var t=this._transformState;null!==t.writechunk&&t.writecb&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},t.prototype._destroy=function(t,r){var e=this;n.prototype._destroy.call(this,t,function(t){r(t),e.emit("close")})};