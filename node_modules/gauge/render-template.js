"use strict";function e(e){return"pre"+(e.type[0].toUpperCase()+e.type.slice(1))}function n(e){return"post"+(e.type[0].toUpperCase()+e.type.slice(1))}var t=require("wide-align"),i=require("aproba"),r=require("object-assign"),l=require("./wide-truncate"),u=require("./error"),a=require("./template-item"),h=module.exports=function(f,o,g){var s=function(t,i,l){function f(e,n){if(e.finished)throw new u.Internal("Tried to finish template item that was already finished");if(Infinity===n)throw new u.Internal("Length of template item cannot be infinity");if(null!=n&&(e.length=n),e.minLength=null,e.maxLength=null,--v,e.finished=!0,null==e.length&&(e.length=e.getBaseLength()),null==e.length)throw new u.Internal("Finished template items must have a length");!function(e){e>m&&(e=m),d+=e,m-=e}(e.getLength())}var g,s,p,c=o.map(function(i,f,o){var g=new a(i,t),s=g.type;if(null==g.value)if(s in l)g.value=l[s];else{if(null==g.default)throw new u.MissingTemplateValue(g,l);g.value=g.default}return null==g.value||""===g.value?null:(g.index=f,g.first=0===f,g.last=f===o.length-1,function(t,i){if(t.type)return i[e(t)]||i[n(t)]}(g,l)&&(g.value=function(t,i){var l=r({},g),u=Object.create(i),a=[],f=e(l),o=n(l);return u[f]&&(a.push({value:u[f]}),u[f]=null),l.minLength=null,l.length=null,l.maxLength=null,a.push(l),u[l.type]=u[l.type],u[o]&&(a.push({value:u[o]}),u[o]=null),function(e,n,t){return h(t,a,u)}}(0,l)),g)}).filter(function(e){return null!=e}),d=0,m=t,v=c.length;c.forEach(function(e){if(e.kerning){var n=e.first?0:c[e.index-1].padRight;!e.first&&n<e.kerning&&(e.padLeft=e.kerning-n),e.last||(e.padRight=e.kerning)}}),c.forEach(function(e){null!=e.getBaseLength()&&f(e)}),g=0;do{s=!1,p=Math.round(m/v),c.forEach(function(e){e.finished||e.maxLength&&e.getMaxLength()<p&&(f(e,e.maxLength),s=!0)})}while(s&&g++<c.length);if(s)throw new u.Internal("Resize loop iterated too many times while determining maxLength");g=0;do{s=!1,p=Math.round(m/v),c.forEach(function(e){e.finished||e.minLength&&e.getMinLength()>=p&&(f(e,e.minLength),s=!0)})}while(s&&g++<c.length);if(s)throw new u.Internal("Resize loop iterated too many times while determining minLength");return p=Math.round(m/v),c.forEach(function(e){e.finished||f(e,p)}),c}(f,0,g).map(function(e){return function(n){return function(e,n){var r,u,a,h,f,o=e.getBaseLength(),g="function"==typeof e.value?function(e,n,t){return i("OON",arguments),e.type?e.value(n,n[e.type+"Theme"]||{},t):e.value(n,{},t)}(e,n,o):e.value;return null==g||""===g?"":(r=t[e.align]||t.left,u=e.padLeft?t.left("",e.padLeft):"",a=e.padRight?t.right("",e.padRight):"",h=l(g+"",o),f=r(h,o),u+f+a)}(n,e)}}(g)).join("");return t.left(l(s,f),f)};