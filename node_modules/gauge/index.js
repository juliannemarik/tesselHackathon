"use strict";function t(t,e){return function(){return e.call(t)}}function e(e,i){var h,r,a,_,d;e&&e.write?(r=e,h=i||{}):i&&i.write?(r=i,h=e||{}):(r=o.stderr,h=e||i||{}),this._status={spun:0,section:"",subsection:""},this._paused=!1,this._disabled=!0,this._showing=!1,this._onScreen=!1,this._needsRedraw=!1,this._hideCursor=null==h.hideCursor||h.hideCursor,this._fixedFramerate=null==h.fixedFramerate?!/^v0\.8\./.test(o.version):h.fixedFramerate,this._lastUpdateAt=null,this._updateInterval=null==h.updateInterval?50:h.updateInterval,this._themes=h.themes||n,this._theme=h.theme,a=this._computeTheme(h.theme),_=h.template||[{type:"progressbar",length:20},{type:"activityIndicator",kerning:1,length:1},{type:"section",kerning:1,default:""},{type:"subsection",kerning:1,default:""}],this.setWriteTo(r,h.tty),d=h.Plumbing||s,this._gauge=new d(a,_,this.getWidth()),this._$$doRedraw=t(this,this._doRedraw),this._$$handleSizeChange=t(this,this._handleSizeChange),this._cleanupOnExit=null==h.cleanupOnExit||h.cleanupOnExit,this._removeOnExit=null,h.enabled||null==h.enabled&&this._tty&&this._tty.isTTY?this.enable():this.disable()}var s=require("./plumbing.js"),i=require("has-unicode"),h=require("./has-color.js"),r=require("signal-exit"),n=require("./themes"),a=require("./set-interval.js"),o=require("./process.js"),_=require("./set-immediate");module.exports=e,(e.prototype={}).isEnabled=function(){return!this._disabled},e.prototype.setTemplate=function(t){this._gauge.setTemplate(t),this._showing&&this._requestRedraw()},e.prototype._computeTheme=function(t){var e,s;return t||(t={}),"string"==typeof t?t=this._themes.getTheme(t):!t||0!==Object.keys(t).length&&null==t.hasUnicode&&null==t.hasColor||(e=null==t.hasUnicode?i():t.hasUnicode,s=null==t.hasColor?h:t.hasColor,t=this._themes.getDefault({hasUnicode:e,hasColor:s,platform:t.platform})),t},e.prototype.setThemeset=function(t){this._themes=t,this.setTheme(this._theme)},e.prototype.setTheme=function(t){this._gauge.setTheme(this._computeTheme(t)),this._showing&&this._requestRedraw(),this._theme=t},e.prototype._requestRedraw=function(){this._needsRedraw=!0,this._fixedFramerate||this._doRedraw()},e.prototype.getWidth=function(){return(this._tty&&this._tty.columns||80)-1},e.prototype.setWriteTo=function(t,e){var s=!this._disabled;s&&this.disable(),this._writeTo=t,this._tty=e||t===o.stderr&&o.stdout.isTTY&&o.stdout||t.isTTY&&t||this._tty,this._gauge&&this._gauge.setWidth(this.getWidth()),s&&this.enable()},e.prototype.enable=function(){this._disabled&&(this._disabled=!1,this._tty&&this._enableEvents(),this._showing&&this.show())},e.prototype.disable=function(){this._disabled||(this._showing&&(this._lastUpdateAt=null,this._showing=!1,this._doRedraw(),this._showing=!0),this._disabled=!0,this._tty&&this._disableEvents())},e.prototype._enableEvents=function(){this._cleanupOnExit&&(this._removeOnExit=r(t(this,this.disable))),this._tty.on("resize",this._$$handleSizeChange),this._fixedFramerate&&(this.redrawTracker=a(this._$$doRedraw,this._updateInterval),this.redrawTracker.unref&&this.redrawTracker.unref())},e.prototype._disableEvents=function(){this._tty.removeListener("resize",this._$$handleSizeChange),this._fixedFramerate&&clearInterval(this.redrawTracker),this._removeOnExit&&this._removeOnExit()},e.prototype.hide=function(t){return this._disabled?t&&o.nextTick(t):this._showing?(this._showing=!1,this._doRedraw(),void(t&&_(t))):t&&o.nextTick(t)},e.prototype.show=function(t,e){var s,i,h;if(this._showing=!0,"string"==typeof t)this._status.section=t;else if("object"==typeof t)for(s=Object.keys(t),i=0;i<s.length;++i)h=s[i],this._status[h]=t[h];null!=e&&(this._status.completed=e),this._disabled||this._requestRedraw()},e.prototype.pulse=function(t){this._status.subsection=t||"",this._status.spun++,this._disabled||this._showing&&this._requestRedraw()},e.prototype._handleSizeChange=function(){this._gauge.setWidth(this._tty.columns-1),this._requestRedraw()},e.prototype._doRedraw=function(){var e,s;if(!this._disabled&&!this._paused){if(!this._fixedFramerate){if(e=Date.now(),this._lastUpdateAt&&e-this._lastUpdateAt<this._updateInterval)return;this._lastUpdateAt=e}if(!this._showing&&this._onScreen)return this._onScreen=!1,s=this._gauge.hide(),this._hideCursor&&(s+=this._gauge.showCursor()),this._writeTo.write(s);(this._showing||this._onScreen)&&(this._showing&&!this._onScreen&&(this._onScreen=!0,this._needsRedraw=!0,this._hideCursor&&this._writeTo.write(this._gauge.hideCursor())),this._needsRedraw&&(this._writeTo.write(this._gauge.show(this._status))||(this._paused=!0,this._writeTo.on("drain",t(this,function(){this._paused=!1,this._doRedraw()})))))}};