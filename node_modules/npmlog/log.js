"use strict";var e,t,s,i,r,n,o=require("are-we-there-yet"),l=require("gauge"),a=require("events").EventEmitter,h=exports=module.exports=new a,g=require("util"),u=require("set-blocking"),c=require("console-control-strings");u(!0),e=process.stderr,Object.defineProperty(h,"stream",{set:function(t){e=t,this.gauge&&this.gauge.setWriteTo(e,e)},get:function(){return e}}),h.useColor=function(){return null!=t?t:e.isTTY},h.enableColor=function(){t=!0,this.gauge.setTheme({hasColor:t,hasUnicode:s})},h.disableColor=function(){t=!1,this.gauge.setTheme({hasColor:t,hasUnicode:s})},h.level="info",h.gauge=new l(e,{enabled:!1,theme:{hasColor:h.useColor()},template:[{type:"progressbar",length:20},{type:"activityIndicator",kerning:1,length:1},{type:"section",default:""},":",{type:"logline",kerning:1,default:""}]}),h.tracker=new o.TrackerGroup,h.progressEnabled=h.gauge.isEnabled(),h.enableUnicode=function(){s=!0,this.gauge.setTheme({hasColor:this.useColor(),hasUnicode:s})},h.disableUnicode=function(){s=!1,this.gauge.setTheme({hasColor:this.useColor(),hasUnicode:s})},h.setGaugeThemeset=function(e){this.gauge.setThemeset(e)},h.setGaugeTemplate=function(e){this.gauge.setTemplate(e)},h.enableProgress=function(){this.progressEnabled||(this.progressEnabled=!0,this.tracker.on("change",this.showProgress),this._pause||this.gauge.enable())},h.disableProgress=function(){this.progressEnabled&&(this.progressEnabled=!1,this.tracker.removeListener("change",this.showProgress),this.gauge.disable())},r=function(e){return Object.keys(h).forEach(function(t){if("_"!==t[0]&&!i.filter(function(e){return e===t}).length&&!e[t]&&"function"==typeof h[t]){var s=h[t];e[t]=function(){return s.apply(h,arguments)}}}),e instanceof o.TrackerGroup&&i.forEach(function(t){var s=e[t];e[t]=function(){return r(s.apply(e,arguments))}}),e},(i=["newGroup","newItem","newStream"]).forEach(function(e){h[e]=function(){return r(this.tracker[e].apply(this.tracker,arguments))}}),h.clearProgress=function(e){if(!this.progressEnabled)return e&&process.nextTick(e);this.gauge.hide(e)},h.showProgress=function(e,t){var s,i,r,n;this.progressEnabled&&(s={},e&&(s.section=e),(i=h.record[h.record.length-1])&&(s.subsection=i.prefix,r=h.disp[i.level]||i.level,n=this._format(r,h.style[i.level]),i.prefix&&(n+=" "+this._format(i.prefix,this.prefixStyle)),n+=" "+i.message.split(/\r?\n/)[0],s.logline=n),s.completed=t||this.tracker.completed(),this.gauge.show(s))}.bind(h),h.pause=function(){this._paused=!0,this.progressEnabled&&this.gauge.disable()},h.resume=function(){if(this._paused){this._paused=!1;var e=this._buffer;this._buffer=[],e.forEach(function(e){this.emitLog(e)},this),this.progressEnabled&&this.gauge.enable()}},h._buffer=[],n=0,h.record=[],h.maxRecordSize=1e4,h.log=function(e,t,s){var i,r,o,l,a,h,u;if(void 0===this.levels[e])return this.emit("error",Error(g.format("Undefined log level: %j",e)));for(i=Array(arguments.length-2),r=null,o=2;o<arguments.length;o++)"object"==typeof(l=i[o-2]=arguments[o])&&l&&l instanceof Error&&l.stack&&Object.defineProperty(l,"stack",{value:r=l.stack+"",enumerable:!0,writable:!0});r&&i.unshift(r+"\n"),s=g.format.apply(g,i),a={id:n++,level:e,prefix:(t||"")+"",message:s,messageRaw:i},this.emit("log",a),this.emit("log."+e,a),a.prefix&&this.emit(a.prefix,a),this.record.push(a),h=this.maxRecordSize,this.record.length-h>h/10&&(u=Math.floor(.9*h),this.record=this.record.slice(-1*u)),this.emitLog(a)}.bind(h),h.emitLog=function(e){var t,s;this._paused?this._buffer.push(e):(this.progressEnabled&&this.gauge.pulse(e.prefix),void 0!==(t=this.levels[e.level])&&(t<this.levels[this.level]||t>0&&!isFinite(t)||(s=null!=h.disp[e.level]?h.disp[e.level]:e.level,this.clearProgress(),e.message.split(/\r?\n/).forEach(function(t){this.heading&&(this.write(this.heading,this.headingStyle),this.write(" ")),this.write(s,h.style[e.level]);var i=e.prefix||"";i&&this.write(" "),this.write(i,this.prefixStyle),this.write(" "+t+"\n")},this),this.showProgress())))},h._format=function(t,s){var i,r;if(e)return i="",this.useColor()&&(r=[],(s=s||{}).fg&&r.push(s.fg),s.bg&&r.push("bg"+s.bg[0].toUpperCase()+s.bg.slice(1)),s.bold&&r.push("bold"),s.underline&&r.push("underline"),s.inverse&&r.push("inverse"),r.length&&(i+=c.color(r)),s.beep&&(i+=c.beep())),i+=t,this.useColor()&&(i+=c.color("reset")),i},h.write=function(t,s){e&&e.write(this._format(t,s))},h.addLevel=function(e,t,s,i){null==i&&(i=e),this.levels[e]=t,this.style[e]=s,this[e]||(this[e]=function(){var t,s=Array(arguments.length+1);for(s[0]=e,t=0;t<arguments.length;t++)s[t+1]=arguments[t];return this.log.apply(this,s)}.bind(this)),this.disp[e]=i},h.prefixStyle={fg:"magenta"},h.headingStyle={fg:"white",bg:"black"},h.style={},h.levels={},h.disp={},h.addLevel("silly",-Infinity,{inverse:!0},"sill"),h.addLevel("verbose",1e3,{fg:"blue",bg:"black"},"verb"),h.addLevel("info",2e3,{fg:"green"}),h.addLevel("timing",2500,{fg:"green",bg:"black"}),h.addLevel("http",3e3,{fg:"green",bg:"black"}),h.addLevel("notice",3500,{fg:"blue",bg:"black"}),h.addLevel("warn",4e3,{fg:"black",bg:"yellow"},"WARN"),h.addLevel("error",5e3,{fg:"red",bg:"black"},"ERR!"),h.addLevel("silent",Infinity),h.on("error",function(){});