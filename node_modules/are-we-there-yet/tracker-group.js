"use strict";var t,e=require("util"),i=require("./tracker-base.js"),r=require("./tracker.js"),n=require("./tracker-stream.js"),h=module.exports=function(t){i.call(this,t),this.parentGroup=null,this.trackers=[],this.completion={},this.weight={},this.totalWeight=0,this.finished=!1,this.bubbleChange=function(t){return function(e,i,r){t.completion[r.id]=i,t.finished||t.emit("change",e||t.name,t.completed(),t)}}(this)};e.inherits(h,i),h.prototype.nameInTree=function(){for(var t=[],e=this;e;)t.unshift(e.name),e=e.parentGroup;return t.join("/")},h.prototype.addUnit=function(t,e){if(t.addUnit){for(var i=this;i;){if(t===i)throw Error("Attempted to add tracker group "+t.name+" to tree that already includes it "+this.nameInTree(this));i=i.parentGroup}t.parentGroup=this}return this.weight[t.id]=e||1,this.totalWeight+=this.weight[t.id],this.trackers.push(t),this.completion[t.id]=t.completed(),t.on("change",this.bubbleChange),this.finished||this.emit("change",t.name,this.completion[t.id],t),t},h.prototype.completed=function(){var t,e,i,r;if(0===this.trackers.length)return 0;for(t=1/this.totalWeight,e=0,i=0;i<this.trackers.length;i++)r=this.trackers[i].id,e+=t*this.weight[r]*this.completion[r];return e},h.prototype.newGroup=function(t,e){return this.addUnit(new h(t),e)},h.prototype.newItem=function(t,e,i){return this.addUnit(new r(t,e),i)},h.prototype.newStream=function(t,e,i){return this.addUnit(new n(t,e),i)},h.prototype.finish=function(){var t,e;for(this.finished=!0,this.trackers.length||this.addUnit(new r,1,!0),t=0;t<this.trackers.length;t++)(e=this.trackers[t]).finish(),e.removeListener("change",this.bubbleChange);this.emit("change",this.name,1,this)},t="                                  ",h.prototype.debug=function(e){var i,r;return e=e||0,i=e?t.substr(0,e):"",r=i+(this.name||"top")+": "+this.completed()+"\n",this.trackers.forEach(function(t){r+=t instanceof h?t.debug(e+1):i+" "+t.name+": "+t.completed()+"\n"}),r};